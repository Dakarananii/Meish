extends layout/layout

block meta

  meta(property="og:type" content="article")
  meta(property="og:site_name" content="Meish*")
  meta(property="og:title" content=`${personality.nameJa} | ${personality.label}`)
  meta(property="og:description" content=personality.introduction.slice(0,200))
  meta(property="og:url" content="http://www.meish.me/i/"+owner.username)
  if personality.ogp_path
    meta(property="og:image" content=`${personality.ogp_path}`)
  else
    meta(property="og:image" content='https://meish.s3-ap-northeast-1.amazonaws.com/meish_logo_ogp.jpg')
  meta(name="twitter:card" content="summary_large_image")
  meta(name="twitter:site" content="@"+owner.username)

  link(rel="stylesheet" href="/css/i/i.css")
  if !(mode == "edit")
    link(rel="stylesheet" href="/css/i/notme.css")

block content
  // 背景を固定化するCSS（スマホで背景流れちゃう対策）
  - var back = personality.logo_path ? personality.logo_path : '/img/logos/meish_logo_back.png'
  style(type="text/css").
    body::before{
      content: '';
      display:block;
      position:fixed;
      top:0;
      left:0;
      z-index:-1;
      width:100%;
      height: 100vh;
      background:url(#{back});
      background-position:  center center;
      background-repeat: no-repeat;
      background-size: contain;
      -webkit-background-size: contain;
      filter: opacity(50%);
    }
  section(style="border-top: solid 1px; padding-bottom:80px;").page-section.bg-gray
    div.profile.container.justify-content-center.rounded
      // 操作パネル
      if isMe 
        if (!personality.ogp_path || !personality.thumbnail_path || !visibility)
          div(style="width:100%; background-color: #F6F6F6; border-radius:10px; padding: 10px;").my-3
            ul(style="margin: 0;")
              if !personality.ogp_path
                li 
                  span
                    a(href="https://www.google.com/search?q=OGP" target="_blank").text-danger  OGPイメージ
                  span.text-dark （URL展開用の画像）がありません 
                  span(data-toggle="modal" data-target="#OgpModal" style="cursor: pointer;").text-info ≫設定する
              if !personality.thumbnail_path
                li 
                  span.text-danger 検索用サムネイル
                  span.text-dark  がありません（TOP画面や検索結果に表示されません）
                  span(data-toggle="modal" data-target="#TachieModal" style="cursor: pointer;").text-info ≫設定する
              if !visibility
                li プロフィールは
                  span.text-danger  非公開状態 
                  span です 

        p
          div.d-flex.flex-wrap
            div.ml-2.mt-2
              // 公開/非公開
              form(method='post' action='/i/'+me.username+'/visibility' id="VisibilityForm" style="display: inline-flex;").edit
                input(type="hidden" name="visibility" value=visibility)
                input(type="hidden" name="_csrf" value=csrfToken)
                if visibility
                  button.btn-sm.btn-outline-danger
                    i.fas.fa-stop  非公開にする
                else
                  button.btn-sm.btn-outline-info 
                    i.fas.fa-play  公開する
            
            div.ml-2.mt-2
              // 編集/プレビュー
              if mode == "edit"
                a#viewLink
                  button.btn-sm.btn-outline-success
                    i.fas.fa-eye  閲覧モードにする
              else
                a#editLink
                  button.btn-sm.btn-outline-info
                    i.fas.fa-pen  編集モードにする

            div.ml-2.mt-2
              // 使い方
              a(href="/howto" target="_blank")
                button.btn-sm.btn-outline-secondary
                  i.fas.fa-question-circle  使いかた

            // Tweetボタン
            div(style="position: relative; top:1px;").ml-2.mt-2
              a(href="https://twitter.com/share" class="twitter-share-button"
                data-url="http://www.meish.me/i/"+owner.username
                data-text=personality.nameJa+"のバーチャルプロフィール / Meish* "
                data-lang="ja"
                data-hashtags="Meish"
                data-size="large"
              ) ツイート
              script(async src="https://platform.twitter.com/widgets.js" charset="utf-8")


      // 背景画像
      - var backImage = personality.back_path ? `background-image:url(${personality.back_path}); background-size: cover; background-position:center;border-radius:8px;` : "";
      div(style=backImage).profileImage.row.m-0
        // プロフィール画像
        - var backImage = personality.tachie ? `background-image:url(${personality.tachie}); border-radius:0px;` : "";
        div(style=backImage+"width:100%; margin:0;").profileImage.row
          if personality.tachie
            input(type="hidden" value=personality.tachie)#tachieSource
          div(style="width:550px; max-width:100%;").personalities.py-2
            div

              // 編集ボタン
              div.m-3.text-right
                i(data-toggle="modal" data-target="#BasicInfoModal" style="cursor: pointer; font-size: 1.6rem;").fas.fa-pen.text-info.edit
              
              div(style="margin-top:.83rem;").mx-2.my-3
                // よみ
                div(style="font-size: 1.2rem;").text-secondary.shadow-gray.mx-1.nameEn #{personality.nameEn}
                // 名前
                div(style="font-size: 2.5rem; line-height:1.2;").name 
                  b #{personality.nameJa}
              // プロフィール本文
              hr.profHR
              h5.m-2.text-secondary.shadow-gray
                span #{personality.label}
              p(style="white-space:pre-wrap;")#introduction.shadow-gray.m-2 #{personality.introduction}
              hr.profHR

            // カテゴリ情報
            .container.m-2.shadow-gray
              .row
                mixin categorizedInfo(title, name)

                  div(style="min-width:250px;").mt-2
                    div(style=" margin-bottom: 0.5rem;").d-flex.align-items-center
                      h3.category #{title}
                        small
                          i(data-toggle="modal" data-target="#"+name+"Modal" style="cursor: pointer;").mx-2.fas.fa-pen.text-info.edit
                    div
                      block

                include i_icons.pug
                  
                // ハッシュタグ
                if hashTags.length > 0 || (isMe && mode == "edit")
                  +categorizedInfo('ハッシュタグ', 'HashTag')
                    each tag in hashTags
                      p.mx-2
                        b
                          a(href="https://twitter.com/hashtag/"+tag.name target="_blank").no-shadow ##{tag.name}
                        if tag.comment
                          span.text-secondary  - #{tag.comment}

                // 活動場所
                if activities.length > 0 || (isMe && mode == "edit")
                  +categorizedInfo('活動場所', 'Activity')
                    each activity in activities
                      p.mx-2
                        if activity.link
                          b
                            a(href=activity.link target="_blank").no-shadow
                              img(src="/img/i/icons/"+getIcon(activity.link) style="width:22px;padding-bottom:4px;")
                              span.mx-2 #{activity.name}
                        else
                          span #{activity.name}

                // 応援方法
                if cheerings.length > 0 || (isMe && mode == "edit")
                  +categorizedInfo('応援する', 'Cheering')
                    each cheer in cheerings
                      p.mx-2 
                        if cheer.link
                          b
                            a(href=cheer.link target="_blank").no-shadow
                              img(src="/img/i/icons/"+getIcon(cheer.link) style="width:22px;padding-bottom:4px;")
                              span.mx-2 #{cheer.name}
                        else
                          span #{cheer.name}
            
            // 検索タグ
            div(style="text-shadow: none;")
              h5
                p
                  each tag in tags
                    - var tagLink = "/search?query=" + tag.tagname
                    - var tagHue = tag.tagname.charCodeAt(0) % 36 * 10;
                    - var tagText = tag.tagname
                    a(href=tagLink)
                      span(style=`background-color:hsl(${tagHue}, 50%, 45%);`).badge.badge-secondary.p-2.m-1 #{tagText}
                  // 編集ボタン
                  i(data-toggle="modal" data-target="#BasicInfoModal" style="position:relative; top:3px; cursor: pointer; font-size: 1.4rem;").m-1.fas.fa-pen.text-info.edit
              div.edit.mx-1.mb-2
                a(href="/tag_suggest" target="_blank") 人気タグを見る

      // ママ/パパ（キャラ絵右下）
      .text-right
        if parents.length != 0
          each parent in parents
            div
              - var parentDisplay = parent.relationship ? `${parent.relationship}: ${parent.name}` : parent.name
              if parent.link
                a(href=parent.link) #{parentDisplay}
              else
                span #{parentDisplay}
        else
          h5.edit 関係者・協力者
        i(data-toggle="modal" data-target="#ParentModal" style="cursor: pointer;").fas.fa-pen.text-info.edit

  // サブセクション雛形
  mixin subSection(title,bg)
    section(class=bg)#about.page-section
      div(style="max-width:100%;").container
        .text-center
          if title
            h1 #{title}
            hr.divider.my-4
          block

  // 立ち絵
  if tachies.length > 0 || (isMe && mode == "edit")
    // コンテンツ
    +subSection('立ち絵')
      .d-flex.flex-wrap
          // 初期表示
          - var tachiesView = tachies.length != 0 ? tachies.slice(0, 5) : []
          if isMe && mode == "edit" && tachies.length < 5
            - tachiesView.push({path: '/img/i/add.png', name: 'Title', comment: '', updatedAt: new Date()})
          each tachie in tachiesView
            .col-sm.mx-auto.m-2
              .tachie.card
                // 画像
                img(src=`${tachie.path}` style="" data-toggle="modal" data-target="#TachieModal").tachie.card-img-top
                if tachie.name || tachie.comment
                  div(style="background-color:rgba(255,255,255,1.00);").card-body
                    // タイトル、コメント
                    h5.card-title #{tachie.name}
                    p.card-text #{tachie.comment}

  // キャラデザ
  if personality.design_path || (isMe && mode == "edit")
    +subSection('キャラクターデザイン', 'bg-white')
        if isMe && mode == "edit"
          p.text-secondary 三面図などキャラクターのディティールがわかる画像を設定します
        .row.justify-content-center
          .card
            - var design_path = personality.design_path ? personality.design_path : "/img/i/add.png";
            - var description = personality.design_path ? personality.design_comment : "キャラデザの詳細とか書けます";
            div.rounded.img-fluid.card-img-top
              img(src=`${design_path}` style="max-width:100%; max-height:500px;" data-toggle="modal" data-target="#DesignModal")
            if description
              .card-body
                p(style="white-space:pre-wrap;").card-text #{description}

  // 紹介動画
  if personality.movie_id || (isMe && mode == "edit")
    +subSection('紹介動画')
      if isMe && mode == "edit"
        p.text-secondary YouTubeのみ対応
        button(data-toggle="modal" data-target="#MovieModal").btn.btn-info.m-3 動画URLを入力
      if personality.movie_id
        div(style="width:90%; max-width:640px;").mx-auto.m-4
          .youtube-inner
            iframe(width="640" height="360" src="https://www.youtube.com/embed/"+personality.movie_id frameborder="0" allow="autoplay; encrypted-media" allowfullscreen).mx-auto

  // ロゴ/背景
  if isMe && mode == "edit"
    div.edit
      +subSection('ロゴ/背景', 'bg-white')
        p.text-secondary ページ背景に表示されます
          br
          | イメージ画像やキャラクターロゴを設定してください
        .row.justify-content-center
          - var logoPath = personality.logo_path ? personality.logo_path : "/img/i/add.png";
            .card
              div.rounded.img-fluid.card-img-top
                img(src=`${logoPath}` style="width:auto;max-height:400px;" data-toggle="modal" data-target="#LogoModal").rounded.img-fluid

  // OGP画像
  if isMe && mode == "edit"
    div.edit
      +subSection('OGPイメージ')
        p.text-secondary TwitterなどにURLを貼り付けた時の画像展開で表示されます
        - var ogpPath = personality.ogp_path ? personality.ogp_path : "/img/i/add.png";
        div(style="max-width:600px;").card.mx-auto
          div.rounded.img-fluid.card-img-top
            img(src=`${ogpPath}` style="max-height:400px;" data-toggle="modal" data-target="#OgpModal").rounded.img-fluid
        p.text-secondary.mt-2 Twitter Card のプレビューやキャッシュ削除は 
          a(href="https://cards-dev.twitter.com/validator" target="_blank") こちら(Twitter Card validator)

  // サムネイル
  if isMe && mode == "edit"
    div.edit
      +subSection('検索サムネイル', 'bg-white')
        p.text-secondary 検索ページで表示されます
          br
          small （立ち絵登録時に設定できます）
        div(style=`border: solid 1px lightgray; border-radius: .25rem; width: 200px; height: 350px; background-image: url(${personality.thumbnail_path}); background-size: contain; background-position:center; background-repeat: no-repeat; background-color: rgba(255,255,255,0.5); margin:auto;`).img-fluid

  if isMe && mode == "edit"
    include i_modals.pug

  // アカウント削除
  if isMe && mode == "edit"
    section(class=bg)#about.page-section.bg-secondary
      .container
        .row.justify-content-center
          .text-center
            form(method='post' action='/i/'+me.username+'/destroy' id="DestroyForm" style="display: inline-flex;").edit.mx-2
              input(type="hidden" name="_csrf" value=csrfToken)
              button(type="submit" onclick="return confirm('本当にアカウントを削除しますか？')").btn-sm.btn-danger アカウントを削除